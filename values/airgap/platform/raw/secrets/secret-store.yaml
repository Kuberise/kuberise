# ==========================================
# Generate Random Strings
# ==========================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: grafana-random-string
spec:
  refreshInterval: "0" # 0 means the secret is not re-generated
  target:
    name: grafana-random-string
    creationPolicy: Owner
  dataFrom:
    - sourceRef:
        generatorRef:
          apiVersion: generators.external-secrets.io/v1alpha1
          kind: ClusterGenerator
          name: password-generator
---
# ==================================================================================================
# Generate client-secrets for keycloak namespace and also for the client application namespaces
# ==================================================================================================
apiVersion: external-secrets.io/v1beta1
kind: ClusterExternalSecret
metadata:
  name: grafana-client-secret
spec:
  externalSecretName: grafana-client-secret

  namespaceSelectors:
    - matchLabels:
        kubernetes.io/metadata.name: keycloak
    - matchLabels:
        kubernetes.io/metadata.name: monitoring

  refreshTime: "1m"
  externalSecretSpec:
    secretStoreRef:
      name: k8s-store
      kind: ClusterSecretStore

    refreshInterval: "1h"
    target:
      name: grafana-oauth2-client-secret
      creationPolicy: Owner
    data:
      - secretKey: client-secret
        remoteRef:
          key: grafana-random-string
          property: password
          conversionStrategy: Default
          decodingStrategy: None
          metadataPolicy: None
