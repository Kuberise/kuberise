apiVersion: v1
kind: ServiceAccount
metadata:
  name: argocd-job
  namespace: argocd
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: argocd-manager
  namespace: argocd
rules:
- apiGroups: ["argoproj.io"]
  resources: ["appprojects", "applications"]
  verbs: ["get", "list", "watch", "create", "update", "delete", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: argocd-manager-binding
  namespace: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: argocd-manager
subjects:
- kind: ServiceAccount
  name: argocd-job
  namespace: argocd
---
apiVersion: batch/v1
kind: Job
metadata:
  name: argocd-app-deploy
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      serviceAccountName: argocd-job
      containers:
      - name: kubectl
        image: bitnami/kubectl:latest
        env:
        - name: REPO_URL
          value: "https://github.com/kuberise/kuberise.git"
        - name: TARGET_REVISION
          value: "HEAD"
        - name: projectName
          value: {{ .Values.argocd.appProject.name }}
        - name: environment
          value: {{ .Values.environment }}
        command:
          - /bin/bash
          - -c
          - |
            cat <<EOF | kubectl apply -f -
            apiVersion: argoproj.io/v1alpha1
            kind: AppProject
            metadata:
              name: $projectName-$environment
            spec:
              sourceRepos:
              - '*'
              destinations:
              - name: '*'
                namespace: '*'
                server: https://kubernetes.default.svc
              clusterResourceWhitelist:
              - group: '*'
                kind: '*'
              namespaceResourceWhitelist:
              - group: '*'
                kind: '*'
            ---
            apiVersion: argoproj.io/v1alpha1
            kind: Application
            metadata:
              name: app-of-apps-$environment
              namespace: argocd
              finalizers:
                - resources-finalizer.argocd.argoproj.io
              labels:
                team: $projectName
            spec:
              destination:
                namespace: argocd
                server: https://kubernetes.default.svc
              project: $projectName-$environment
              source:
                path: ./app-of-apps
                repoURL: '$REPO_URL'
                targetRevision: '$TARGET_REVISION'
                helm:
                  valueFiles:
                    - values-$environment.yaml
              syncPolicy:
                automated:
                  prune: true
                  selfHeal: true
            EOF
      restartPolicy: Never
---
apiVersion: batch/v1
kind: Job
metadata:
  name: argocd-app-delete
  annotations:
    "helm.sh/hook": pre-delete
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      serviceAccountName: argocd-job
      containers:
      - name: kubectl
        image: bitnami/kubectl:latest
        command:
          - /bin/bash
          - -c
          - |
            kubectl delete application app-of-apps-dta -n argocd || true
            kubectl delete appproject platform-dta -n argocd || true
      restartPolicy: Never
